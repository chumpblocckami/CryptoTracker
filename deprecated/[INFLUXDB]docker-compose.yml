version: '3'
services:
  influxdb:
    image: influxdb:latest
    hostname: influxdb
    volumes:
      # Mount for influxdb data directory and configuration
      - /influxdb:/var/lib/influxdb2:rw
    ports:
      - "8086:8086"
  influxdb_cli:
      links:
        - influxdb
      image: influxdb:latest
      volumes:
        # Mount for influxdb data directory and configuration
        - influxdb:/var/lib/influxdb2:rw
        - ./ssl/influxdb-selfsigned.crt:/etc/ssl/influxdb-selfsigned.crt:rw
        - ./ssl/influxdb-selfsigned.key:/etc/ssl/influxdb-selfsigned.key:rw
      environment:
         # Use these same configurations parameters in your telegraf configuration, mytelegraf.conf.
        - DOCKER_INFLUXDB_INIT_MODE=setup
        - DOCKER_INFLUXDB_INIT_USERNAME=${USERNAME}
        - DOCKER_INFLUXDB_INIT_PASSWORD=${PASSWORD}
        - DOCKER_INFLUXDB_INIT_ORG=${INFLUX_ORG}
        - DOCKER_INFLUXDB_INIT_BUCKET=${INFLUX_BUCKET}
        - DOCKER_INFLUXDB_INIT_ADMIN_TOKEN=${INFLUX_TOKEN}
        - INFLUXD_TLS_CERT=/etc/ssl/influxdb-selfsigned.crt
        - INFLUXD_TLS_KEY=/etc/ssl/influxdb-selfsigned.key
      entrypoint: ["./entrypoint.sh"]
      restart: on-failure:10
      depends_on:
        - influxdb

  #backend:
  #  build:
  #    context: backend
  #  environment:
  #    - TZ=Europe/Rome
  #    - APP_ID=${INFLUX_URL}
  #    - SUBSCRIPTION_KEY=${INFLUX_TOKEN}
  #    - ACTIVE_SERVER=${INFLUX_ORG}
    #volumes:
  #  depends_on:
  #    influxdb:
  #      condition: "service_healthy"
volumes:
  influxdbv2: